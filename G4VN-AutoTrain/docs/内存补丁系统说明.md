# 内存补丁系统说明

## 问题分析

根据日志和您的描述：
1. **EXE程序中没有文本资源**：文本不在资源文件中
2. **文本在内存中**：界面文本是运行时加载到内存的
3. **窗口补丁无效**：UIChinesePatcher可能无法找到窗口或窗口文本

## 解决方案

创建了**内存字符串补丁系统**（`MemoryStringPatcher.cs`），直接搜索并替换目标程序内存中的越南文字符串。

## 工作原理

### 1. 内存搜索
- 在目标进程的内存空间中搜索越南文字符串
- 搜索范围：程序基址到基址+16MB
- 支持多种编码：ANSI和UTF-8

### 2. 字符串替换
- 找到字符串后，直接修改内存
- 如果新字符串比旧字符串短，用0填充
- 如果新字符串比旧字符串长，跳过（避免覆盖其他数据）

### 3. 持续监控
- 每5秒重新搜索并补丁
- 处理动态加载的字符串

## 已集成的功能

内存补丁系统已经集成到 `CrackVLBS19v3.cs` 中：

1. **VLBS 1.9 版本**：在破解完成后启动内存补丁
2. **VLBS 1.3 版本**：在破解完成后启动内存补丁

## 翻译映射表

包含以下常见文本的翻译：

| 越南文 | 中文 |
|--------|------|
| Luyện công | 练功 |
| Nhiệm vụ Dã tẩu | 日常任务 |
| PT Nhóm | PT任务 |
| Tự vệ | 背包 |
| Tự xếp đồ | 鱼袋 |
| Về thành | 回城 |
| Tử vong | 死亡 |
| Thu nhặt | 拾取 |
| ... | ... |

## 使用方法

**无需额外操作！** 内存补丁系统会在目标程序启动后自动运行。

## 日志信息

内存补丁系统会在日志文件中输出详细信息：

```
MemoryStringPatcher: Starting memory string patching, PID=1234, Handle=2460
MemoryStringPatcher: Base address = 0x00400000
MemoryStringPatcher: Searching memory range 0x00400000 - 0x01400000
MemoryStringPatcher: Found 'Luyện công' at 0x00412345
MemoryStringPatcher: Patched 'Luyện công' -> '练功' at 0x00412345
MemoryStringPatcher: Total patched 15 strings
```

## 如果某些文本仍然没有翻译

如果某些文本仍然没有翻译，可能的原因：

1. **字符串不在搜索范围内**：可能需要扩大搜索范围
2. **编码不匹配**：字符串可能使用了不同的编码
3. **字符串被压缩或加密**：某些字符串可能被处理过

## 添加新的翻译

如果需要添加新的翻译，编辑 `MemoryStringPatcher.cs` 文件中的 `MemoryTranslationMap`：

```csharp
{ "越南文文本", "中文翻译" },
```

## 性能说明

- **内存搜索**：搜索16MB内存可能需要几秒钟
- **持续监控**：每5秒搜索一次，会占用少量CPU资源
- **内存占用**：每次搜索使用64KB缓冲区

## 注意事项

1. **进程句柄**：内存补丁系统需要保持进程句柄打开
2. **延迟**：需要等待进程完全加载后再搜索（8-15秒）
3. **编码**：支持ANSI和UTF-8编码，但可能还有其他编码方式

## 调试

查看日志文件 `patcher_log.txt`，查找：
- `"MemoryStringPatcher: Starting memory string patching"` - 内存补丁启动
- `"MemoryStringPatcher: Found '...' at 0x..."` - 找到字符串
- `"MemoryStringPatcher: Patched '...' -> '...'"` - 成功补丁
- `"MemoryStringPatcher: Not found '...' in memory"` - 未找到字符串

---

**创建日期：** 2024年  
**状态：** ✅ 已集成到破解流程中
